{% extends "base_admin.html" %}
{% block content %}
<div class="w-full px-4 sm:px-6 lg:px-8">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <div>
      <h2 class="text-xl sm:text-2xl font-extrabold tracking-tight">User Management</h2>
      <p class="text-[#5a8c88] font-medium text-sm sm:text-base">Manage workers and administrators</p>
    </div>
    <button onclick="document.getElementById('workerModal').classList.remove('hidden')" class="inline-flex items-center justify-center gap-2 bg-primary text-white px-4 py-2.5 rounded-lg font-bold text-sm hover:bg-primary/90 transition-colors w-full sm:w-auto">
      <span class="material-symbols-outlined text-[18px]">person_add</span>
      Add New User
    </button>
  </div>

  <!-- Stats Cards -->
  <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6 mb-6 sm:mb-8">
    <div class="bg-white dark:bg-[#1a2b2a] p-4 sm:p-6 rounded-xl border border-[#d3e3e2] dark:border-[#2a3a39] shadow-sm">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-[#5a8c88] text-xs sm:text-sm font-medium">Total Users</p>
          <p class="text-2xl sm:text-3xl font-extrabold mt-1">{{ stats.total_users }}</p>
        </div>
        <div class="size-10 sm:size-12 rounded-full bg-primary/10 flex items-center justify-center">
          <span class="material-symbols-outlined text-primary text-xl sm:text-2xl">group</span>
        </div>
      </div>
    </div>
    <div class="bg-white dark:bg-[#1a2b2a] p-4 sm:p-6 rounded-xl border border-[#d3e3e2] dark:border-[#2a3a39] shadow-sm">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-[#5a8c88] text-xs sm:text-sm font-medium">Admins</p>
          <p class="text-2xl sm:text-3xl font-extrabold mt-1 text-purple-600">{{ stats.admins }}</p>
        </div>
        <div class="size-10 sm:size-12 rounded-full bg-purple-100 flex items-center justify-center">
          <span class="material-symbols-outlined text-purple-600 text-xl sm:text-2xl">admin_panel_settings</span>
        </div>
      </div>
    </div>
    <div class="bg-white dark:bg-[#1a2b2a] p-4 sm:p-6 rounded-xl border border-[#d3e3e2] dark:border-[#2a3a39] shadow-sm">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-[#5a8c88] text-xs sm:text-sm font-medium">Workers</p>
          <p class="text-2xl sm:text-3xl font-extrabold mt-1 text-blue-600">{{ stats.workers }}</p>
        </div>
        <div class="size-10 sm:size-12 rounded-full bg-blue-100 flex items-center justify-center">
          <span class="material-symbols-outlined text-blue-600 text-xl sm:text-2xl">badge</span>
        </div>
      </div>
    </div>
    <div class="bg-white dark:bg-[#1a2b2a] p-4 sm:p-6 rounded-xl border border-[#d3e3e2] dark:border-[#2a3a39] shadow-sm">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-[#5a8c88] text-xs sm:text-sm font-medium">Invoices</p>
          <p class="text-2xl sm:text-3xl font-extrabold mt-1 text-green-600">{{ stats.total_invoices }}</p>
        </div>
        <div class="size-10 sm:size-12 rounded-full bg-green-100 flex items-center justify-center">
          <span class="material-symbols-outlined text-green-600 text-xl sm:text-2xl">description</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Users Table Card -->
  <div class="bg-white dark:bg-[#1a2b2a] rounded-xl border border-[#d3e3e2] dark:border-[#2a3a39] shadow-sm overflow-hidden">
    <!-- Table Header with Search/Filter -->
    <div class="p-4 sm:p-6 border-b border-[#d3e3e2] dark:border-[#2a3a39]">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <h3 class="text-lg font-bold">All Users</h3>
        <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 sm:gap-3">
          <div class="relative flex-1 sm:flex-none">
            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-[#5a8c88] text-[18px]">search</span>
            <input type="text" id="userSearch" placeholder="Search users..." class="w-full sm:w-52 lg:w-64 pl-10 pr-4 py-2.5 text-sm border border-[#d3e3e2] rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white dark:bg-[#233534] dark:border-[#2a3a39]">
          </div>
          <select id="roleFilter" class="px-4 py-2.5 text-sm border border-[#d3e3e2] rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white dark:bg-[#233534] dark:border-[#2a3a39]">
            <option value="">All Roles</option>
            <option value="admin">Administrators</option>
            <option value="worker">Workers</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Desktop Table View (Hidden on Mobile) -->
    <div class="hidden md:block overflow-x-auto">
      <table class="w-full text-left min-w-[800px]">
        <thead class="bg-[#f9fafa] dark:bg-[#233534] text-[#5a8c88] text-[11px] font-bold uppercase tracking-wider">
          <tr>
            <th class="px-6 py-4">User</th>
            <th class="px-6 py-4">Worker ID</th>
            <th class="px-6 py-4">Position</th>
            <th class="px-6 py-4">Location</th>
            <th class="px-6 py-4">Role</th>
            <th class="px-6 py-4">Invoices</th>
            <th class="px-6 py-4">Revenue</th>
            <th class="px-6 py-4">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-[#d3e3e2] dark:divide-[#2a3a39]" id="usersBody">
          {% for user_data in users %}
          <tr class="user-row hover:bg-gray-50 dark:hover:bg-[#233534]/50 transition-colors" data-role="{{ user_data.user.role }}" data-name="{{ user_data.user.full_name|lower }}">
            <td class="px-6 py-4">
              <div class="flex items-center gap-3">
                {% if user_data.user.image_path %}
                {% if user_data.user.image_path.startswith('http') %}
                <img src="{{ user_data.user.image_path }}" alt="" class="size-10 rounded-full object-cover border-2 border-white shadow-sm">
                {% else %}
                <img src="{{ url_for('static', filename=user_data.user.image_path) }}" alt="" class="size-10 rounded-full object-cover border-2 border-white shadow-sm">
                {% endif %}
                {% else %}
                <div class="size-10 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold text-sm border-2 border-white shadow-sm">
                  {{ user_data.user.full_name[:2].upper() }}
                </div>
                {% endif %}
                <div>
                  <p class="font-bold text-sm">{{ user_data.user.full_name }}</p>
                  <p class="text-xs text-[#5a8c88]">{{ user_data.user.nationality or 'Not specified' }}</p>
                </div>
              </div>
            </td>
            <td class="px-6 py-4">
              <span class="font-mono text-sm bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded select-all">{{ user_data.user.worker_id }}</span>
            </td>
            <td class="px-6 py-4 text-sm">{{ user_data.user.position or '—' }}</td>
            <td class="px-6 py-4 text-sm text-[#5a8c88]">{{ user_data.user.location or '—' }}</td>
            <td class="px-6 py-4">
              {% if user_data.user.role == 'admin' %}
              <span class="inline-flex items-center gap-1 px-3 py-1 bg-purple-100 text-purple-800 text-[11px] font-bold rounded-full">
                <span class="material-symbols-outlined text-[14px]">shield</span> Admin
              </span>
              {% else %}
              <span class="inline-flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-800 text-[11px] font-bold rounded-full">
                <span class="material-symbols-outlined text-[14px]">badge</span> Worker
              </span>
              {% endif %}
            </td>
            <td class="px-6 py-4">
              <span class="text-sm font-bold">{{ user_data.invoice_count }}</span>
            </td>
            <td class="px-6 py-4">
              <span class="text-sm font-bold text-green-600">GH₵{{ "{:,.2f}".format(user_data.revenue) }}</span>
            </td>
            <td class="px-6 py-4">
              <div class="flex items-center gap-2">
                <button onclick="viewUserDetails({{ user_data.user.id }}, '{{ user_data.user.full_name }}', '{{ user_data.user.worker_id }}', '{{ user_data.user.position or '' }}', '{{ user_data.user.location or '' }}', '{{ user_data.user.nationality or '' }}', '{{ user_data.user.role }}', {{ user_data.invoice_count }}, {{ user_data.revenue }})" class="size-8 rounded-lg border border-[#d3e3e2] flex items-center justify-center text-[#5a8c88] hover:bg-gray-50 hover:text-primary transition-colors" title="View Details">
                  <span class="material-symbols-outlined text-[18px]">visibility</span>
                </button>
                <a href="{{ url_for('edit_user', user_id=user_data.user.id) }}" class="size-8 rounded-lg border border-[#d3e3e2] flex items-center justify-center text-[#5a8c88] hover:bg-gray-50 hover:text-blue-600 transition-colors" title="Edit">
                  <span class="material-symbols-outlined text-[18px]">edit</span>
                </a>
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="8" class="px-6 py-12 text-center">
              <div class="flex flex-col items-center gap-3">
                <span class="material-symbols-outlined text-5xl text-[#d3e3e2]">group_off</span>
                <p class="text-[#5a8c88]">No users found</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Mobile Card View (Hidden on Desktop) -->
    <div class="md:hidden" id="userCardsContainer">
      {% for user_data in users %}
      <div class="user-card border-b border-[#d3e3e2] dark:border-[#2a3a39] p-4 hover:bg-gray-50 dark:hover:bg-[#233534]/50 transition-colors" data-role="{{ user_data.user.role }}" data-name="{{ user_data.user.full_name|lower }}">
        <div class="flex items-start justify-between mb-3">
          <div class="flex items-center gap-3">
            {% if user_data.user.image_path %}
            {% if user_data.user.image_path.startswith('http') %}
            <img src="{{ user_data.user.image_path }}" alt="" class="size-12 rounded-full object-cover border-2 border-white shadow-sm">
            {% else %}
            <img src="{{ url_for('static', filename=user_data.user.image_path) }}" alt="" class="size-12 rounded-full object-cover border-2 border-white shadow-sm">
            {% endif %}
            {% else %}
            <div class="size-12 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold text-base border-2 border-white shadow-sm">
              {{ user_data.user.full_name[:2].upper() }}
            </div>
            {% endif %}
            <div>
              <p class="font-bold text-base">{{ user_data.user.full_name }}</p>
              <p class="text-xs text-[#5a8c88]">{{ user_data.user.nationality or 'Not specified' }}</p>
            </div>
          </div>
          {% if user_data.user.role == 'admin' %}
          <span class="inline-flex items-center gap-1 px-2 py-1 bg-purple-100 text-purple-800 text-[10px] font-bold rounded-full">
            <span class="material-symbols-outlined text-[12px]">shield</span> Admin
          </span>
          {% else %}
          <span class="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-800 text-[10px] font-bold rounded-full">
            <span class="material-symbols-outlined text-[12px]">badge</span> Worker
          </span>
          {% endif %}
        </div>
        
        <div class="grid grid-cols-2 gap-3 mb-3 text-sm">
          <div>
            <p class="text-[#5a8c88] text-xs uppercase font-medium">Worker ID</p>
            <p class="font-mono bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded text-xs inline-block mt-0.5">{{ user_data.user.worker_id }}</p>
          </div>
          <div>
            <p class="text-[#5a8c88] text-xs uppercase font-medium">Position</p>
            <p class="font-medium mt-0.5">{{ user_data.user.position or '—' }}</p>
          </div>
          <div>
            <p class="text-[#5a8c88] text-xs uppercase font-medium">Location</p>
            <p class="font-medium mt-0.5">{{ user_data.user.location or '—' }}</p>
          </div>
          <div>
            <p class="text-[#5a8c88] text-xs uppercase font-medium">Invoices</p>
            <p class="font-bold mt-0.5">{{ user_data.invoice_count }}</p>
          </div>
        </div>
        
        <div class="flex items-center justify-between pt-3 border-t border-[#d3e3e2] dark:border-[#2a3a39]">
          <div>
            <p class="text-[#5a8c88] text-xs uppercase font-medium">Revenue</p>
            <p class="font-bold text-green-600 text-lg">GH₵{{ "{:,.2f}".format(user_data.revenue) }}</p>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="viewUserDetails({{ user_data.user.id }}, '{{ user_data.user.full_name }}', '{{ user_data.user.worker_id }}', '{{ user_data.user.position or '' }}', '{{ user_data.user.location or '' }}', '{{ user_data.user.nationality or '' }}', '{{ user_data.user.role }}', {{ user_data.invoice_count }}, {{ user_data.revenue }})" class="flex items-center gap-1 px-3 py-2 rounded-lg border border-[#d3e3e2] text-[#5a8c88] hover:bg-gray-50 hover:text-primary transition-colors text-sm font-medium">
              <span class="material-symbols-outlined text-[16px]">visibility</span>
              View
            </button>
            <a href="{{ url_for('edit_user', user_id=user_data.user.id) }}" class="flex items-center gap-1 px-3 py-2 rounded-lg border border-[#d3e3e2] text-[#5a8c88] hover:bg-gray-50 hover:text-blue-600 transition-colors text-sm font-medium">
              <span class="material-symbols-outlined text-[16px]">edit</span>
              Edit
            </a>
          </div>
        </div>
      </div>
      {% else %}
      <div class="p-8 text-center">
        <span class="material-symbols-outlined text-5xl text-[#d3e3e2]">group_off</span>
        <p class="text-[#5a8c88] mt-2">No users found</p>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- User Details Modal -->
<div id="userDetailsModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
  <div class="bg-white dark:bg-[#1a2b2a] rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
    <div class="sticky top-0 bg-white dark:bg-[#1a2b2a] p-4 sm:p-6 border-b border-[#d3e3e2] dark:border-[#2a3a39] flex items-center justify-between">
      <h2 class="text-lg sm:text-xl font-bold">User Details</h2>
      <button onclick="document.getElementById('userDetailsModal').classList.add('hidden')" class="size-8 rounded-full hover:bg-gray-100 dark:hover:bg-[#233534] flex items-center justify-center">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <div id="userDetailsContent" class="p-4 sm:p-6">
      <!-- Content loaded dynamically -->
    </div>
  </div>
</div>

<!-- Add User Modal -->
<div id="workerModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
  <div class="bg-white dark:bg-[#1a2b2a] rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
    <div class="sticky top-0 bg-white dark:bg-[#1a2b2a] p-4 sm:p-6 border-b border-[#d3e3e2] dark:border-[#2a3a39] flex items-center justify-between">
      <h2 class="text-lg sm:text-xl font-bold">Add New User</h2>
      <button onclick="document.getElementById('workerModal').classList.add('hidden')" class="size-8 rounded-full hover:bg-gray-100 dark:hover:bg-[#233534] flex items-center justify-center">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <form action="{{ url_for('auth.create_worker') }}" method="POST" enctype="multipart/form-data" class="p-4 sm:p-6 space-y-4">
      <div>
        <label class="block text-sm font-medium mb-1.5">Full Name <span class="text-red-500">*</span></label>
        <input type="text" name="full_name" required class="w-full px-4 py-2.5 border border-[#d3e3e2] rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white dark:bg-[#233534] dark:border-[#2a3a39]" placeholder="John Doe">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1.5">Position <span class="text-red-500">*</span></label>
        <input type="text" name="position" required class="w-full px-4 py-2.5 border border-[#d3e3e2] rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white dark:bg-[#233534] dark:border-[#2a3a39]" placeholder="Field Engineer">
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1.5">Location</label>
          <input type="text" name="location" class="w-full px-4 py-2.5 border border-[#d3e3e2] rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white dark:bg-[#233534] dark:border-[#2a3a39]" placeholder="Accra">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1.5">Nationality</label>
          <input type="text" name="nationality" class="w-full px-4 py-2.5 border border-[#d3e3e2] rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white dark:bg-[#233534] dark:border-[#2a3a39]" placeholder="Ghanaian">
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1.5">Role <span class="text-red-500">*</span></label>
        <select name="role" required class="w-full px-4 py-2.5 border border-[#d3e3e2] rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white dark:bg-[#233534] dark:border-[#2a3a39]">
          <option value="worker">Worker</option>
          <option value="admin">Administrator</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1.5">Profile Photo</label>
        <input type="file" name="image" accept="image/*" class="w-full px-4 py-2 border border-[#d3e3e2] rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white dark:bg-[#233534] dark:border-[#2a3a39] text-sm file:mr-3 file:py-1.5 file:px-3 file:rounded-lg file:border-0 file:bg-primary/10 file:text-primary file:font-medium">
      </div>
      <div class="flex gap-3 pt-4">
        <button type="button" onclick="document.getElementById('workerModal').classList.add('hidden')" class="flex-1 px-4 py-2.5 border border-[#d3e3e2] rounded-lg font-medium hover:bg-gray-50 transition-colors">Cancel</button>
        <button type="submit" class="flex-1 px-4 py-2.5 bg-primary text-white rounded-lg font-bold hover:bg-primary/90 transition-colors">Create User</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Search and filter functionality
const searchInput = document.getElementById('userSearch');
const roleFilter = document.getElementById('roleFilter');

function filterUsers() {
  const search = searchInput.value.toLowerCase();
  const role = roleFilter.value;
  
  // Filter table rows
  document.querySelectorAll('.user-row').forEach(row => {
    const name = row.dataset.name;
    const userRole = row.dataset.role;
    const matchesSearch = name.includes(search);
    const matchesRole = !role || userRole === role;
    row.style.display = matchesSearch && matchesRole ? '' : 'none';
  });
  
  // Filter mobile cards
  document.querySelectorAll('.user-card').forEach(card => {
    const name = card.dataset.name;
    const userRole = card.dataset.role;
    const matchesSearch = name.includes(search);
    const matchesRole = !role || userRole === role;
    card.style.display = matchesSearch && matchesRole ? '' : 'none';
  });
}

searchInput.addEventListener('input', filterUsers);
roleFilter.addEventListener('change', filterUsers);

function viewUserDetails(userId, fullName, workerId, position, location, nationality, role, invoiceCount, revenue) {
  document.getElementById('userDetailsModal').classList.remove('hidden');
  
  const roleHtml = role === 'admin' 
    ? '<span class="inline-flex items-center gap-1 px-3 py-1 bg-purple-100 text-purple-800 text-xs font-bold rounded-full"><span class="material-symbols-outlined text-[14px]">shield</span> Administrator</span>'
    : '<span class="inline-flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-800 text-xs font-bold rounded-full"><span class="material-symbols-outlined text-[14px]">badge</span> Worker</span>';
  
  document.getElementById('userDetailsContent').innerHTML = `
    <div class="text-center mb-6">
      <div class="size-20 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold text-2xl border-4 border-white shadow-lg mx-auto mb-3">
        ${fullName.substring(0, 2).toUpperCase()}
      </div>
      <h3 class="text-xl font-bold">${fullName}</h3>
      <p class="text-[#5a8c88] text-sm">${nationality || 'Not specified'}</p>
      <div class="mt-2">${roleHtml}</div>
    </div>
    
    <div class="space-y-4">
      <div class="bg-[#f9fafa] dark:bg-[#233534] p-4 rounded-xl">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <p class="text-[#5a8c88] text-xs font-medium uppercase">Worker ID</p>
            <p class="font-mono font-bold mt-1">${workerId}</p>
          </div>
          <div>
            <p class="text-[#5a8c88] text-xs font-medium uppercase">Position</p>
            <p class="font-medium mt-1">${position || '—'}</p>
          </div>
          <div>
            <p class="text-[#5a8c88] text-xs font-medium uppercase">Location</p>
            <p class="font-medium mt-1">${location || '—'}</p>
          </div>
          <div>
            <p class="text-[#5a8c88] text-xs font-medium uppercase">Invoices</p>
            <p class="font-bold mt-1">${invoiceCount}</p>
          </div>
        </div>
      </div>
      
      <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-xl">
        <p class="text-[#5a8c88] text-xs font-medium uppercase">Total Revenue</p>
        <p class="text-2xl font-bold text-green-600 mt-1">GH₵${revenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
      </div>
    </div>
    
    <div class="flex gap-3 mt-6">
      <a href="/edit-user/${userId}" class="flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-primary text-white rounded-lg font-bold hover:bg-primary/90 transition-colors">
        <span class="material-symbols-outlined text-[18px]">edit</span>
        Edit User
      </a>
      <button onclick="document.getElementById('userDetailsModal').classList.add('hidden')" class="flex-1 px-4 py-2.5 border border-[#d3e3e2] rounded-lg font-medium hover:bg-gray-50 transition-colors">Close</button>
    </div>
  `;
}

// Close modals on click outside
document.getElementById('userDetailsModal').addEventListener('click', function(e) {
  if (e.target === this) this.classList.add('hidden');
});

document.getElementById('workerModal').addEventListener('click', function(e) {
  if (e.target === this) this.classList.add('hidden');
});

// Close modals on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    document.getElementById('userDetailsModal').classList.add('hidden');
    document.getElementById('workerModal').classList.add('hidden');
  }
});
</script>
{% endblock %}
